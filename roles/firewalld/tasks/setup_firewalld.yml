---

# - name: Install backend for RHEL7
#   become: yes
#   ansible.builtin.package:
#     name: iptables
#     state: present
#   when: ansible_distribution_major_version == "7"
#   notify: Start and enable firewalld

- name: Install firewalld
  become: yes
  ansible.builtin.package:
    name: firewalld
    state: present
  notify: Start and enable firewalld

- name: Configure firewalld
  become: yes
  ansible.builtin.template:
    src: templates/firewalld.conf.j2
    dest: /etc/firewalld/firewalld.conf
    backup: yes
    owner: root
    group: root
    mode: '0644'
  notify: Reload firewalld

# template validate is not usable because firewall-offline-cmd
# --system-config wants a folder, not the content of the file.
- name: Validate the configuration
  become: yes
  ansible.builtin.command:
    cmd: >
      /usr/bin/firewall-offline-cmd --system-config /etc/firewalld
      --check-config
  changed_when: false
  register: firewalld_validate_config_result

- name: Check if configuration is valid
  become: yes
  assert:
    that:
      - "'ERROR' not in firewalld_validate_config_result.stderr"
      - "'WARNING' not in firewalld_validate_config_result.stderr"
    fail_msg: >
      The file /etc/firewalld/firewalld.cmd returned errors or warnings. Fix
      the configuration then run `/usr/bin/firewall-offline-cmd --system-config
      /etc/firewalld --check-config` again

- name: Force handler to ensure firewalld is up for create_new_zones.yml
  meta: flush_handlers
