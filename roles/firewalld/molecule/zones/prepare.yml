---

# We must store the containers dynamically assigned IP addresses to allow
# us to use it in our firewall tests scenario

- name: Prepare
  hosts: zones
  gather_facts: false
  tasks:

    - name: Get IP
      connection: local
      delegate_to: localhost
      shell:
        cmd: >
          podman inspect
          -f "{{ '{{' }} .NetworkSettings.IPAddress {{ '}}' }}"
          {{ inventory_hostname }}
      register: container_ip
      changed_when: false

    # iproute provides commands: ip, route, ss, ...
    # iputils provides commands: ping, arping, tracepath, ...
    - name: Install ip packages for debugging
      yum:
        name:
          - iproute
          - iputils
        state: present

    - name: Get default interface name
      shell:
        cmd: ip -0 -4 route show default | awk '{ print $5 }'
      register: container_interface

    - name: Create custom fact folder
      file:
        path: /etc/ansible/facts.d
        state: directory
        recurse: true

    - name: Create custom fact to store IP address
      template:
        src: ./custom_facts.j2
        dest: /etc/ansible/facts.d/molecule.fact
