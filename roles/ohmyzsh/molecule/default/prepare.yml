---

- name: Prepare
  hosts: ohmyzsh
  gather_facts: false
  tasks:

    - name: Prepare - Install packages
      ansible.builtin.package:
        name:
          - sudo  # for become
          - zsh
          - util-linux-user  # for chsh
        state: present

    - name: Prepare - Unmask systemd-logind.service
      ansible.builtin.systemd:
        name: systemd-logind.service
        masked: false

    # In ubi8 we are always root. This doesn't reflect a real world
    # scenario when ssh connections to root are forbidden. To help
    # us see when a task need the become directive, we will connect
    # to this unprivileged user.
    - name: Prepare - Create ansible user
      ansible.builtin.user:
        name: ansible
        state: present

    - name: Prepare - Allow ansible to sudo without password
      ansible.builtin.copy:
        content: "ansible ALL=(ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/10-ansible
        validate: /usr/sbin/visudo -csf %s
        owner: root
        group: root
        mode: '0644'

    - name: Prepare - Create test users
      ansible.builtin.user:
        name: "{{ item }}"
        state: present
      loop:
        - user_01
        - user_auto_title
        - user_title
        - user_custom_function

    - name: Prepare - Change shell to zsh for test users
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /bin/zsh
      loop:
        - root
        - user_01
        - user_auto_title
        - user_title
        - user_custom_function
