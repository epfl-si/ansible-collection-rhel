---
# tasks file for ohmyzsh

- name: Ensure dependencies are installed
  become: true
  ansible.builtin.package:
    name:
      - zsh
      - git
    state: present

- name: Ensure oh-my-zsh folder is present
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.file:
    path: ~/.oh-my-zsh
    state: directory
    owner: "{{ ohmyzsh_user }}"
    group: "{{ ohmyzsh_user }}"
    mode: '0700'

- name: Init and configure GIT
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.shell:  # noqa command-instead-of-module
    cmd: >
      git init ~/.oh-my-zsh
      && cd ~/.oh-my-zsh
      && git config core.eol lf
      && git config core.autocrlf false
      && git config fsck.zeroPaddedFilemode ignore
      && git config fetch.fsck.zeroPaddedFilemode ignore
      && git config receive.fsck.zeroPaddedFilemode ignore
      && git config oh-my-zsh.remote origin
      && git config oh-my-zsh.branch master
      && git remote add origin https://github.com/ohmyzsh/ohmyzsh.git
      && git fetch --depth=1 origin
      && git checkout -b master origin/master
    creates: ~/.oh-my-zsh/.git

- name: Install plugins
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.git:  # noqa latest[git]
    dest: ~/.oh-my-zsh/custom/plugins/{{ item.dest }}
    repo: "{{ item.repo }}"
    depth: 1
    update: false
  loop:
    - dest: zsh-autosuggestions
      repo: https://github.com/zsh-users/zsh-autosuggestions.git
    - dest: zsh-completions
      repo: https://github.com/zsh-users/zsh-completions.git
    - dest: zsh-syntax-highlighting
      repo: https://github.com/zsh-users/zsh-syntax-highlighting.git

- name: Install mh-hostname custom theme
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.copy:
    content:
      "# Based on mh theme\n
      # preview: https://cl.ly/1y2x0W0E3t2C0F29043z\n
      # Edited to add hostname in the prompt\n
      \n
      # if superuser make the username green\n
      if [ $UID -eq 0 ]; then NCOLOR=\"green\"; else NCOLOR=\"white\"; fi\n
      \n
      # prompt\n
      PROMPT='[%{$fg[$NCOLOR]%}%B%n%b%{$reset_color%}@%m:%{$fg[red]%}%30<...<%~%\
      <<%{$reset_color%}]%(!.#.$) '\n
      RPROMPT='$(git_prompt_info)'\n
      \n
      # git theming\n
      ZSH_THEME_GIT_PROMPT_PREFIX=\"%{$fg_bold[gray]%}(%{$fg_no_bold[yellow]%}%\
      B\"\n
      ZSH_THEME_GIT_PROMPT_SUFFIX=\"%b%{$fg_bold[gray]%})%{$reset_color%} \"\n
      ZSH_THEME_GIT_PROMPT_CLEAN=\"\n
      ZSH_THEME_GIT_PROMPT_DIRTY=\"%{$fg_bold[red]%}âœ±\"\n

      # LS colors, made with https://geoff.greer.fm/lscolors/\n
      export LSCOLORS=\"Gxfxcxdxbxegedabagacad\"\n
      export LS_COLORS='no=00:fi=00:di=01;34:ln=00;36:pi=40;33:so=01;35:do=01;\
      35:bd=40;33;01:cd=40;33;01:or=41;33;01:ex=00;32:*.cmd=00;32:*.exe=01;32:\
      *.com=01;32:*.bat=01;32:*.btm=01;32:*.dll=01;32:*.tar=00;31:*.tbz=00;31:\
      *.tgz=00;31:*.rpm=00;31:*.deb=00;31:*.arj=00;31:*.taz=00;31:*.lzh=00;31:\
      *.lzma=00;31:*.zip=00;31:*.zoo=00;31:*.z=00;31:*.Z=00;31:*.gz=00;31:*.bz\
      2=00;31:*.tb2=00;31:*.tz2=00;31:*.tbz2=00;31:*.avi=01;35:*.bmp=01;35:*.f\
      li=01;35:*.gif=01;35:*.jpg=01;35:*.jpeg=01;35:*.mng=01;35:*.mov=01;35:*.\
      mpg=01;35:*.pcx=01;35:*.pbm=01;35:*.pgm=01;35:*.png=01;35:*.ppm=01;35:*.\
      tga=01;35:*.tif=01;35:*.xbm=01;35:*.xpm=01;35:*.dl=01;35:*.gl=01;35:*.wm\
      v=01;35:*.aiff=00;32:*.au=00;32:*.mid=00;32:*.mp3=00;32:*.ogg=00;32:*.vo\
      c=00;32:*.wav=00;32:'"
    dest: ~/.oh-my-zsh/custom/themes/mh-hostname.zsh-theme
    owner: "{{ ohmyzsh_user }}"
    group: "{{ ohmyzsh_user }}"
    mode: '0644'

- name: Ensure ~/.common_profile and ~/.z exists
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.file:
    path: "{{ ohmyzsh_necessary_files_item }}"
    state: touch
    owner: "{{ ohmyzsh_user }}"
    group: "{{ ohmyzsh_user }}"
    mode: '0644'
    access_time: preserve
    modification_time: preserve
  loop:
    - ~/.common_profile
    - ~/.z
  loop_control:
    loop_var: ohmyzsh_necessary_files_item

# Must use force because role epfl_si.rhel.user creates an empty .zshrc file
- name: Create the .zshrc file
  become: true
  become_user: "{{ ohmyzsh_user }}"
  ansible.builtin.template:
    src: templates/zshrc.j2
    dest: ~/.zshrc
    owner: "{{ ohmyzsh_user }}"
    group: "{{ ohmyzsh_user }}"
    mode: '0644'
    force: true
    backup: true
